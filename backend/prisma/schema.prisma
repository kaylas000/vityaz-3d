// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String   @id @default(cuid())
  username          String   @unique
  tonAddress        String   @unique
  email             String   @unique
  avatar            String?
  
  // Economy
  vityazBalance     BigInt   @default(0)
  totalEarned       BigInt   @default(0)
  
  // Stats
  level             Int      @default(1)
  experience        Int      @default(0)
  kills             Int      @default(0)
  deaths            Int      @default(0)
  wins              Int      @default(0)
  losses            Int      @default(0)
  
  // Status
  lastLogin         DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  battles           Battle[]
  nfts              NFT[]
  stakes            Stake[]
  marketplaceListings MarketplaceListing[]
  tournaments       TournamentParticipant[]
  
  @@index([tonAddress])
  @@map("users")
}

model Battle {
  id                String   @id @default(cuid())
  playerId          String
  player            User     @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  difficulty        String   // EASY, MEDIUM, HARD
  score             Int
  kills             Int
  deaths            Int
  duration          Int      // seconds
  
  // Rewards
  tokensEarned      Int
  experienceGained  Int
  
  createdAt         DateTime @default(now())
  
  @@index([playerId])
  @@index([createdAt])
  @@map("battles")
}

model NFT {
  id                String   @id @default(cuid())
  tokenId           String   @unique
  ownerId           String
  owner             User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  type              String   // OPERATOR, WEAPON, EQUIPMENT, BASE, BADGE
  name              String
  rarity            String   // COMMON, RARE, EPIC, LEGENDARY
  metadata          Json     // Custom stats
  
  listed            Boolean  @default(false)
  listedPrice       Int?
  listing           MarketplaceListing?
  
  dailyReward       Int?     // For BASE NFTs
  lastRewardClaimed DateTime?
  
  mintedAt          DateTime @default(now())
  
  @@index([ownerId])
  @@index([type])
  @@map("nfts")
}

model MarketplaceListing {
  id                String   @id @default(cuid())
  nftId             String   @unique
  nft               NFT      @relation(fields: [nftId], references: [id], onDelete: Cascade)
  
  sellerId          String
  seller            User     @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  
  price             Int
  createdAt         DateTime @default(now())
  
  @@index([sellerId])
  @@index([price])
  @@map("marketplace_listings")
}

model Stake {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  amount            BigInt
  apy               Int      // Annual percentage yield
  lockPeriodDays    Int
  
  startedAt         DateTime @default(now())
  unlocksAt         DateTime
  claimedAt         DateTime?
  
  rewards           BigInt   @default(0)
  
  @@index([userId])
  @@index([unlocksAt])
  @@map("stakes")
}

model Tournament {
  id                String   @id @default(cuid())
  name              String
  description       String?
  
  startDate         DateTime
  endDate           DateTime
  
  prizePool         BigInt   // In $VITYAZ
  maxParticipants   Int
  
  participants      TournamentParticipant[]
  
  createdAt         DateTime @default(now())
  
  @@index([startDate])
  @@map("tournaments")
}

model TournamentParticipant {
  id                String   @id @default(cuid())
  tournamentId      String
  tournament        Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  score             Int      @default(0)
  rank              Int?
  prizeWon          BigInt   @default(0)
  
  joinedAt          DateTime @default(now())
  
  @@unique([tournamentId, userId])
  @@index([tournamentId])
  @@map("tournament_participants")
}

model AnticheatReport {
  id                String   @id @default(cuid())
  playerId          String
  suspiciousActions String[] // Array of suspicious behaviors
  score             Float    // 0-100 suspicious score
  reviewed          Boolean  @default(false)
  banned            Boolean  @default(false)
  
  createdAt         DateTime @default(now())
  
  @@index([playerId])
  @@map("anticheat_reports")
}
